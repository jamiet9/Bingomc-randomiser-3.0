<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minecraft Bingo Card Randomiser</title>
  <style>
    /* Basic Reset & Body Styling */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f8ff;
      color: #333;
      text-align: center;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    h2, h3 {
      margin-bottom: 5px;
    }
    /* Top Controls */
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
    }
    #controls label {
      margin-right: 5px;
    }
    /* Card & Grade Display */
    #cardSizeDisplay,
    #gradeDisplay {
      margin-top: 10px;
      font-weight: bold;
      font-size: 16px;
    }
    /* Bingo Card Table */
    #bingoCard table {
      margin: 20px auto;
      border-collapse: collapse;
      table-layout: fixed; /* fixes jitter */
      width: auto;
    }
    #bingoCard td {
      border: 2px solid #333;
      width: 80px;
      height: 80px;
      vertical-align: middle;
      font-size: 12px;
      text-align: center;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      line-height: 1.2;
      min-width: 80px;
      min-height: 80px;
      transition: background-color 0.4s;
    }
    /* Slot Machine Animation */
    #slotMachine {
      display: none;
      margin: 20px auto;
      width: 320px;
      border: 2px solid #333;
      background: #eee;
      padding: 10px;
      text-align: center;
    }
    .reel {
      display: inline-block;
      width: 80px;
      height: 80px;
      margin: 0 5px;
      border: 2px solid #666;
      font-size: 28px;
      line-height: 80px;
      background: #fff;
    }
    /* Rarity Editor Panel */
    #rarityEditor {
      display: none;
      max-width: 900px;
      margin: 20px auto;
      text-align: left;
      border: 1px solid #333;
      background: #fff;
      padding: 10px;
    }
    #rarityEditor h2 {
      margin-top: 0;
      margin-bottom: 5px;
    }
    #rarityEditor p {
      font-size: 14px;
      color: #555;
      margin-bottom: 10px;
    }
    #rarityList {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ccc;
      padding: 5px;
    }
    .itemRow {
      margin-bottom: 5px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .itemRow label {
      width: 60%;
      text-align: left;
    }
    .rarityDropdown {
      width: 120px;
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Minecraft Bingo Card Randomiser</h1>
  <!-- Top Controls -->
  <div id="controls">
    <button id="editRaritiesButton">Edit Item Rarities</button>
    <div>
      <label>Randomize card size?</label>
      <input type="radio" name="sizeOption" id="sizeRandomYes" value="yes" checked> Yes
      <input type="radio" name="sizeOption" id="sizeRandomNo" value="no"> No
    </div>
    <select id="manualSizeSelect" style="display: none;">
      <option value="1">1×1</option>
      <option value="2">2×2</option>
      <option value="3">3×3</option>
      <option value="4">4×4</option>
      <option value="5" selected>5×5</option>
      <option value="6">6×6</option>
      <option value="7">7×7</option>
      <option value="8">8×8</option>
      <option value="9">9×9</option>
      <option value="10">10×10</option>
    </select>
    <button id="generateCardButton">Generate New Card</button>
  </div>
  
  <!-- Slot Machine Animation -->
  <div id="slotMachine">
    <div class="reel" id="reel1">?</div>
    <div class="reel" id="reel2">?</div>
    <div class="reel" id="reel3">?</div>
  </div>
  
  <div id="cardSizeDisplay"></div>
  <div id="bingoCard"></div>
  <div id="gradeDisplay"></div>
  
  <!-- Rarity Editor Panel -->
  <div id="rarityEditor">
    <h2>Edit Item Rarities</h2>
    <p>
      The rarity categories are defined as follows:
      <ul style="list-style-type: none; padding-left: 0;">
        <li><strong>Super Rare</strong> → 0.000001</li>
        <li><strong>Rare</strong> → 0.01</li>
        <li><strong>Uncommon</strong> → 0.5</li>
        <li><strong>Common</strong> → 1</li>
        <li><strong>Very Common</strong> → 2</li>
      </ul>
      Adjust the dropdown for each item to change its rarity. Then click "Save Changes."
    </p>
    <div id="rarityList"></div>
    <button id="saveRaritiesButton">Save Changes</button>
  </div>
  
  <!-- Audio for Animations -->
  <audio id="spinSound" src="https://cdn.pixabay.com/download/audio/2022/08/20/audio_f5a8404616.mp3?filename=casino-slot-machine-112138.mp3"></audio>
  <audio id="revealSound" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_12a42400c4.mp3?filename=retro-game-notification-38284.mp3"></audio>
  
  <!-- Place script at end of body so elements are loaded -->
  <script>
    /***********************************************************
     * 1) FULL ITEM LIST (900+ items)
     * (Ensure the full list from "STONE" to "LIGHTNING_ROD" is included exactly.)
     ***********************************************************/
    const fullItemsString = `STONE
GRANITE
POLISHED_GRANITE
DIORITE
POLISHED_DIORITE
ANDESITE
POLISHED_ANDESITE
DEEPSLATE
COBBLED_DEEPSLATE
POLISHED_DEEPSLATE
CALCITE
DRIPSTONE_BLOCK
GRASS_BLOCK
DIRT
COARSE_DIRT
PODZOL
ROOTED_DIRT
MUD
COBBLESTONE
OAK_PLANKS
SPRUCE_PLANKS
BIRCH_PLANKS
JUNGLE_PLANKS
ACACIA_PLANKS
CHERRY_PLANKS
DARK_OAK_PLANKS
BAMBOO_PLANKS
BAMBOO_MOSAIC
OAK_SAPLING
SPRUCE_SAPLING
BIRCH_SAPLING
JUNGLE_SAPLING
ACACIA_SAPLING
CHERRY_SAPLING
DARK_OAK_SAPLING
MANGROVE_PROPAGULE
SAND
SUSPICIOUS_SAND
SUSPICIOUS_GRAVEL
RED_SAND
GRAVEL
COAL_ORE
IRON_ORE
COPPER_ORE
GOLD_ORE
REDSTONE_ORE
EMERALD_ORE
LAPIS_ORE
DIAMOND_ORE
ANCIENT_DEBRIS
COAL_BLOCK
RAW_IRON_BLOCK
RAW_COPPER_BLOCK
RAW_GOLD_BLOCK
AMETHYST_BLOCK
IRON_BLOCK
COPPER_BLOCK
GOLD_BLOCK
DIAMOND_BLOCK
EXPOSED_COPPER
WEATHERED_COPPER
OXIDIZED_COPPER
CUT_COPPER
EXPOSED_CUT_COPPER
WEATHERED_CUT_COPPER
OXIDIZED_CUT_COPPER
CUT_COPPER_STAIRS
EXPOSED_CUT_COPPER_STAIRS
WEATHERED_CUT_COPPER_STAIRS
OXIDIZED_CUT_COPPER_STAIRS
CUT_COPPER_SLAB
EXPOSED_CUT_COPPER_SLAB
WEATHERED_CUT_COPPER_SLAB
OXIDIZED_CUT_COPPER_SLAB
WAXED_COPPER_BLOCK
WAXED_EXPOSED_COPPER
WAXED_WEATHERED_COPPER
WAXED_OXIDIZED_COPPER
WAXED_CUT_COPPER
WAXED_EXPOSED_CUT_COPPER
WAXED_WEATHERED_CUT_COPPER
WAXED_OXIDIZED_CUT_COPPER
WAXED_CUT_COPPER_STAIRS
WAXED_EXPOSED_CUT_COPPER_STAIRS
WAXED_WEATHERED_CUT_COPPER_STAIRS
WAXED_OXIDIZED_CUT_COPPER_STAIRS
WAXED_CUT_COPPER_SLAB
WAXED_EXPOSED_CUT_COPPER_SLAB
WAXED_WEATHERED_CUT_COPPER_SLAB
WAXED_OXIDIZED_CUT_COPPER_SLAB
OAK_LOG
SPRUCE_LOG
BIRCH_LOG
JUNGLE_LOG
ACACIA_LOG
CHERRY_LOG
DARK_OAK_LOG
MANGROVE_LOG
MANGROVE_ROOTS
MUDDY_MANGROVE_ROOTS
BAMBOO_BLOCK
STRIPPED_OAK_LOG
STRIPPED_SPRUCE_LOG
STRIPPED_BIRCH_LOG
STRIPPED_JUNGLE_LOG
STRIPPED_ACACIA_LOG
STRIPPED_CHERRY_LOG
STRIPPED_DARK_OAK_LOG
STRIPPED_MANGROVE_LOG
STRIPPED_OAK_WOOD
STRIPPED_SPRUCE_WOOD
STRIPPED_BIRCH_WOOD
STRIPPED_JUNGLE_WOOD
STRIPPED_ACACIA_WOOD
STRIPPED_CHERRY_WOOD
STRIPPED_DARK_OAK_WOOD
STRIPPED_MANGROVE_WOOD
STRIPPED_BAMBOO_BLOCK
OAK_WOOD
SPRUCE_WOOD
BIRCH_WOOD
JUNGLE_WOOD
ACACIA_WOOD
CHERRY_WOOD
DARK_OAK_WOOD
MANGROVE_WOOD
OAK_LEAVES
SPRUCE_LEAVES
BIRCH_LEAVES
JUNGLE_LEAVES
ACACIA_LEAVES
CHERRY_LEAVES
DARK_OAK_LEAVES
MANGROVE_LEAVES
AZALEA_LEAVES
FLOWERING_AZALEA_LEAVES
SPONGE
WET_SPONGE
GLASS
TINTED_GLASS
LAPIS_BLOCK
SANDSTONE
CHISELED_SANDSTONE
CUT_SANDSTONE
COBWEB
SHORT_GRASS
FERN
AZALEA
FLOWERING_AZALEA
DEAD_BUSH
SEAGRASS
SEA_PICKLE
WHITE_WOOL
ORANGE_WOOL
MAGENTA_WOOL
LIGHT_BLUE_WOOL
YELLOW_WOOL
LIME_WOOL
PINK_WOOL
GRAY_WOOL
LIGHT_GRAY_WOOL
CYAN_WOOL
PURPLE_WOOL
BLUE_WOOL
BROWN_WOOL
GREEN_WOOL
RED_WOOL
BLACK_WOOL
DANDELION
POPPY
BLUE_ORCHID
ALLIUM
AZURE_BLUET
RED_TULIP
ORANGE_TULIP
WHITE_TULIP
PINK_TULIP
OXEYE_DAISY
CORNFLOWER
LILY_OF_THE_VALLEY
TORCHFLOWER
PITCHER_PLANT
SPORE_BLOSSOM
BROWN_MUSHROOM
RED_MUSHROOM
SUGAR_CANE
KELP
MOSS_CARPET
PINK_PETALS
MOSS_BLOCK
BIG_DRIPLEAF
SMALL_DRIPLEAF
BAMBOO
OAK_SLAB
SPRUCE_SLAB
BIRCH_SLAB
JUNGLE_SLAB
ACACIA_SLAB
CHERRY_SLAB
DARK_OAK_SLAB
MANGROVE_SLAB
BAMBOO_SLAB
BAMBOO_MOSAIC_SLAB
STONE_SLAB
SMOOTH_STONE_SLAB
SANDSTONE_SLAB
CUT_SANDSTONE_SLAB
PETRIFIED_OAK_SLAB
COBBLESTONE_SLAB
BRICK_SLAB
STONE_BRICK_SLAB
MUD_BRICK_SLAB
RED_SANDSTONE_SLAB
CUT_RED_SANDSTONE_SLAB
PRISMARINE_SLAB
PRISMARINE_BRICK_SLAB
DARK_PRISMARINE_SLAB
SMOOTH_RED_SANDSTONE
SMOOTH_SANDSTONE
SMOOTH_STONE
BRICKS
BOOKSHELF
CHISELED_BOOKSHELF
DECORATED_POT
MOSSY_COBBLESTONE
OBSIDIAN
TORCH
CHEST
CRAFTING_TABLE
FURNACE
LADDER
COBBLESTONE_STAIRS
SNOW
ICE
SNOW_BLOCK
CACTUS
CLAY
JUKEBOX
OAK_FENCE
SPRUCE_FENCE
BIRCH_FENCE
JUNGLE_FENCE
ACACIA_FENCE
CHERRY_FENCE
DARK_OAK_FENCE
MANGROVE_FENCE
BAMBOO_FENCE
PUMPKIN
CARVED_PUMPKIN
JACK_O_LANTERN
STONE_BRICKS
MOSSY_STONE_BRICKS
CRACKED_STONE_BRICKS
CHISELED_STONE_BRICKS
PACKED_MUD
MUD_BRICKS
DEEPSLATE_BRICKS
CRACKED_DEEPSLATE_BRICKS
DEEPSLATE_TILES
CRACKED_DEEPSLATE_TILES
CHISELED_DEEPSLATE
REINFORCED_DEEPSLATE
IRON_BARS
CHAIN
GLASS_PANE
MELON
VINE
GLOWSTONE
NETHER_BRICKS
CRACKED_NETHER_BRICKS
CHISELED_NETHER_BRICKS
NETHER_BRICK_FENCE
NETHER_BRICK_STAIRS
CRIMSON_STAIRS
WARPED_STAIRS
NETHER_BRICK_WALL
CHISELED_QUARTZ_BLOCK
QUARTZ_BLOCK
QUARTZ_BRICKS
QUARTZ_PILLAR
QUARTZ_STAIRS
NETHER_WART_BLOCK
WARPED_WART_BLOCK
RED_NETHER_BRICKS
BONE_BLOCK
SMOOTH_QUARTZ_STAIRS
CRIMSON_DOOR
WARPED_DOOR
CRIMSON_TRAPDOOR
WARPED_TRAPDOOR
NETHERITE_INGOT
NETHERITE_SCRAP
QUARTZ
NETHERITE_SWORD
NETHERITE_SHOVEL
NETHERITE_PICKAXE
NETHERITE_AXE
NETHERITE_HOE
NETHERITE_HELMET
NETHERITE_CHESTPLATE
NETHERITE_LEGGINGS
NETHERITE_BOOTS
BLAZE_ROD
GHAST_TEAR
NETHER_WART
BLAZE_POWDER
MAGMA_CREAM
BASALT
SMOOTH_BASALT
POLISHED_BASALT
BLACKSTONE
POLISHED_BLACKSTONE
END_STONE
END_STONE_BRICKS
CHORUS_FRUIT
PURPUR_BLOCK
PURPUR_PILLAR
DRAGON_HEAD
DRAGON_EGG
ELYTRA
REDSTONE_LAMP
LIGHTNING_ROD`;
      
      let fullItemsArray = fullItemsString.split('\n').map(s => s.trim()).filter(s => s && s !== 'SUSPICIOUS_SAND' && s !== 'SUSPICIOUS_GRAVEL' && s !== 'PETRIFIED_OAK_SLAB');
      
      /***********************************************************
       * 2) RARITY SYSTEM – CATEGORIES & DEFAULT VALUES
       ***********************************************************/
      // Define our rarity categories and assign each a numeric value, background and text color, and a score for grading.
      const categoryMapping = {
        "Super Rare": { value: 0.000001, color: "#8A2BE2", textColor: "#FFFFFF", score: 5 },
        "Rare":       { value: 0.01,     color: "#1E90FF", textColor: "#FFFFFF", score: 3 },
        "Uncommon":   { value: 0.5,      color: "#32CD32", textColor: "#FFFFFF", score: 2 },
        "Common":     { value: 1,        color: "#EEEEEE", textColor: "#000000", score: 1 },
        "Very Common":{ value: 2,        color: "#FFD700", textColor: "#000000", score: 0.5 }
      };
      
      function getValueFromCategory(cat) {
        return categoryMapping[cat] ? categoryMapping[cat].value : 1;
      }
      function getColorForCategory(cat) {
        return categoryMapping[cat] ? categoryMapping[cat].color : "#FFFFFF";
      }
      function getTextColorForCategory(cat) {
        return categoryMapping[cat] ? categoryMapping[cat].textColor : "#000000";
      }
      function getCategoryFromValue(value) {
        let bestCat = "Common";
        let minDiff = Infinity;
        for (let cat in categoryMapping) {
          let diff = Math.abs(categoryMapping[cat].value - value);
          if (diff < minDiff) {
            minDiff = diff;
            bestCat = cat;
          }
        }
        return bestCat;
      }
      
      // Default rarity assignment for each item.
      function getItemRarity(item) {
        const name = item.toUpperCase();
        if (name === "GRASS_BLOCK") return 0.01;
        if (name === "MANGROVE_PROPAGULE") return 0.0001;
        // Force CHORUS_FRUIT to be Super Rare.
        if (name === "CHORUS_FRUIT") return 0.000001;
        if (name.endsWith("_ORE")) return 0.01;
        if (name.endsWith("_BLOCK") && /COAL|IRON|COPPER|GOLD|DIAMOND|EMERALD|LAPIS|AMETHYST/.test(name)) return 0.5;
        if (name.includes("INGOT") && /IRON|COPPER|GOLD/.test(name)) return 0.5;
        if ((name.includes("IRON") || name.includes("GOLD") || name.includes("COPPER")) &&
            /SWORD|PICKAXE|AXE|SHOVEL|HOE|HELMET|CHESTPLATE|LEGGINGS|BOOTS/.test(name))
          return 0.5;
        if (["CUT_COPPER","CUT_COPPER_STAIRS","CUT_COPPER_SLAB","COPPER_GRATE"].includes(name)) return 0.4;
        // Waxed, Exposed, Weathered, Oxidized variants become Super Rare.
        if (name.includes("COPPER") && (name.includes("WAXED") || name.includes("EXPOSED") ||
            name.includes("WEATHERED") || name.includes("OXIDIZED")))
          return 0.000001;
        if (/_LOG$/.test(name) || /_WOOD$/.test(name) || /_PLANKS$/.test(name) ||
            /_SAPLING$/.test(name) || /_LEAVES$/.test(name))
          return 1;
        if (["STONE","COBBLESTONE","DIRT","COARSE_DIRT","PODZOL","ROOTED_DIRT","MUD"].includes(name))
          return 1;
        if (name.endsWith("_SLAB") || name.endsWith("_STAIRS") || name.endsWith("_WALL")) {
          if (name.includes("PRISMARINE") || name.includes("SEA_LANTERN")) return 0.2;
          return 1;
        }
        if (name === "SPONGE" || name === "WET_SPONGE") return 0.01;
        if (name.includes("PITCHER_PLANT") || name.includes("TORCHFLOWER") ||
            name.includes("PITCHER_SEED") || name.includes("TORCHFLOWER_SEED"))
          return 0.01;
        if (name.includes("PRISMARINE") || name.includes("SEA_LANTERN")) return 0.2;
        if (name === "CONDUIT") return 0.001;
        if (["END_STONE","END_STONE_BRICKS","PURPUR_BLOCK","PURPUR_PILLAR"].includes(name))
          return 0.0001;
        if (name.includes("NETHERITE")) return 0.001;
        if (name.includes("BLAZE") || name === "ENDER_PEARL") return 0.001;
        if (name.includes("ANCIENT_DEBRIS")) return 0.005;
        if (name.includes("BASALT") || name.includes("BLACKSTONE") ||
            name.includes("NETHERRACK") || name.includes("GLOWSTONE"))
          return 0.02;
        if (name.includes("SADDLE") || name.includes("NAME_TAG") ||
            name.includes("ENCHANTING_TABLE") || name.includes("ANVIL"))
          return 0.01;
        if (name.includes("GOLDEN_APPLE") || name.includes("POTION") ||
            name.includes("BREWING_STAND"))
          return 0.01;
        return 1;
      }
      
      // Build initial rarity mapping for all items.
      let rarityMapping = {};
      fullItemsArray.forEach(item => {
        rarityMapping[item] = getItemRarity(item);
      });
      
      /***********************************************************
       * 3) CARD GENERATION – Rarity Roll then Random Item
       ***********************************************************/
      // Fixed category probabilities (must sum to 1)
      const fixedCategoryProbabilities = {
        "Super Rare": 0.05,
        "Rare": 0.15,
        "Uncommon": 0.30,
        "Common": 0.40,
        "Very Common": 0.10
      };
      
      // For each cell, roll a rarity category and then choose a random item from that category.
      function generateCardArray(size) {
        let pool = fullItemsArray.slice();
        let card = [];
        let overallScore = 0;
        for (let i = 0; i < size; i++) {
          card[i] = [];
          for (let j = 0; j < size; j++) {
            let roll = Math.random();
            let cumulative = 0, chosenCat = "Common";
            for (let cat in fixedCategoryProbabilities) {
              cumulative += fixedCategoryProbabilities[cat];
              if (roll < cumulative) {
                chosenCat = cat;
                break;
              }
            }
            let available = pool.filter(item => getCategoryFromValue(rarityMapping[item]) === chosenCat);
            let chosenItem;
            if (available.length > 0) {
              chosenItem = available[Math.floor(Math.random() * available.length)];
            } else {
              chosenItem = pool[Math.floor(Math.random() * pool.length)];
              chosenCat = getCategoryFromValue(rarityMapping[chosenItem]);
            }
            pool.splice(pool.indexOf(chosenItem), 1);
            card[i][j] = { item: chosenItem, category: chosenCat };
            overallScore += categoryMapping[chosenCat].score;
          }
        }
        card[0][0]._overallScore = overallScore;
        return card;
      }
      
      function computeCardGrade(card, size) {
        const maxScore = 5 * size * size; // if all cells are Super Rare
        const ratio = card[0][0]._overallScore / maxScore;
        if (ratio >= 0.8) return "Legendary Card";
        if (ratio >= 0.6) return "Epic Card";
        if (ratio >= 0.4) return "Rare Card";
        if (ratio >= 0.2) return "Common Card";
        return "Very Common Card";
      }
      
      function buildCardTable(card) {
        let size = card.length;
        let table = document.createElement("table");
        table.style.tableLayout = "fixed";
        for (let i = 0; i < size; i++) {
          let tr = document.createElement("tr");
          for (let j = 0; j < size; j++) {
            let td = document.createElement("td");
            td.innerText = "";
            tr.appendChild(td);
          }
          table.appendChild(tr);
        }
        document.getElementById("bingoCard").innerHTML = "";
        document.getElementById("bingoCard").appendChild(table);
        return table;
      }
      
      async function revealCardSequentially(card, table) {
        let size = card.length;
        let cells = table.getElementsByTagName("td");
        let cellDelay = 500;
        for (let i = 0; i < size; i++) {
          for (let j = 0; j < size; j++) {
            let cell = cells[i * size + j];
            await revealCell(cell, card[i][j].item, card[i][j].category, cellDelay);
          }
        }
      }
      
      function revealCell(cellElem, finalItem, rarityCategory, revealTime) {
        return new Promise(resolve => {
          let startTime = Date.now();
          let interval = setInterval(() => {
            if (Date.now() - startTime >= revealTime) {
              clearInterval(interval);
              cellElem.innerHTML = finalItem + "<br><span style='font-size:10px;'>" + rarityCategory + "</span>";
              cellElem.style.backgroundColor = getColorForCategory(rarityCategory);
              cellElem.style.color = getTextColorForCategory(rarityCategory);
              let revealSound = document.getElementById("revealSound");
              if (revealSound) {
                revealSound.currentTime = 0;
                revealSound.play();
              }
              resolve();
            } else {
              cellElem.innerText = fullItemsArray[Math.floor(Math.random() * fullItemsArray.length)];
            }
          }, 50);
        });
      }
      
      async function animateSlotMachine(finalSize) {
        return new Promise(resolve => {
          let slotMachine = document.getElementById("slotMachine");
          slotMachine.style.display = "block";
          let reel1 = document.getElementById("reel1");
          let reel2 = document.getElementById("reel2");
          let reel3 = document.getElementById("reel3");
          let sizes = [1,2,3,4,5,6,7,8,9,10];
          let interval = setInterval(() => {
            reel1.innerText = sizes[Math.floor(Math.random()*sizes.length)] + "×" + sizes[Math.floor(Math.random()*sizes.length)];
            reel2.innerText = sizes[Math.floor(Math.random()*sizes.length)] + "×" + sizes[Math.floor(Math.random()*sizes.length)];
            reel3.innerText = sizes[Math.floor(Math.random()*sizes.length)] + "×" + sizes[Math.floor(Math.random()*sizes.length)];
          }, 100);
          setTimeout(() => {
            clearInterval(interval);
            let display = finalSize + "×" + finalSize;
            reel1.innerText = display;
            reel2.innerText = display;
            reel3.innerText = display;
            let spinSound = document.getElementById("spinSound");
            if (spinSound) {
              spinSound.currentTime = 0;
              spinSound.play();
            }
            setTimeout(() => {
              slotMachine.style.display = "none";
              resolve(finalSize);
            }, 500);
          }, 2000);
        });
      }
      
      async function main() {
        document.getElementById("generateCardButton").disabled = true;
        document.getElementById("gradeDisplay").innerText = "";
        document.getElementById("cardSizeDisplay").innerText = "";
        document.getElementById("bingoCard").innerHTML = "";
      
        let size = await getCardSize();
        document.getElementById("cardSizeDisplay").innerText = `Card Size: ${size}×${size}`;
      
        let card = generateCardArray(size);
        let table = buildCardTable(card);
        await revealCardSequentially(card, table);
      
        let grade = computeCardGrade(card, size);
        document.getElementById("gradeDisplay").innerText = `Card Rarity Grade: ${grade}`;
      
        document.getElementById("generateCardButton").disabled = false;
      }
      
      /***********************************************************
       * 4) RARITY EDITOR – DROPDOWNS & INFO PANEL
       ***********************************************************/
      function toggleRarityEditor() {
        let panel = document.getElementById("rarityEditor");
        panel.style.display = (panel.style.display === "none" || panel.style.display === "") ? "block" : "none";
      }
      
      function buildRarityEditor() {
        let list = document.getElementById("rarityList");
        list.innerHTML = "";
        fullItemsArray.forEach(item => {
          let row = document.createElement("div");
          row.className = "itemRow";
      
          let label = document.createElement("label");
          label.innerText = item;
      
          let currentVal = rarityMapping[item];
          let currentCat = getCategoryFromValue(currentVal);
      
          let dropdown = document.createElement("select");
          dropdown.className = "rarityDropdown";
          dropdown.dataset.item = item;
          for (let catName in categoryMapping) {
            let opt = document.createElement("option");
            opt.value = catName;
            opt.textContent = catName;
            if (catName === currentCat) {
              opt.selected = true;
            }
            dropdown.appendChild(opt);
          }
      
          row.appendChild(label);
          row.appendChild(dropdown);
          list.appendChild(row);
        });
      }
      
      function saveRarities() {
        document.querySelectorAll(".rarityDropdown").forEach(dropdown => {
          let item = dropdown.dataset.item;
          let chosenCat = dropdown.value;
          rarityMapping[item] = getValueFromCategory(chosenCat);
        });
        alert("Rarity values saved!");
        console.log("Updated rarity mapping:", rarityMapping);
      }
      
      /***********************************************************
       * 5) EVENT LISTENERS
       ***********************************************************/
      document.getElementById("generateCardButton").addEventListener("click", main);
      document.getElementById("editRaritiesButton").addEventListener("click", () => {
        toggleRarityEditor();
        buildRarityEditor();
      });
      document.getElementById("saveRaritiesButton").addEventListener("click", saveRarities);
      
      document.getElementById("sizeRandomYes").addEventListener("change", () => {
        document.getElementById("manualSizeSelect").style.display = "none";
      });
      document.getElementById("sizeRandomNo").addEventListener("change", () => {
        document.getElementById("manualSizeSelect").style.display = "inline-block";
      });
      
    }); // End DOMContentLoaded
  </script>
</body>
</html>
